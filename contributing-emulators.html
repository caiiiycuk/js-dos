<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="built-on" content="2024-10-03T11:04:49.3261717"><script type="text/javascript" >
   (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
   m[i].l=1*new Date();
   for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
   k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
   (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

   ym(27763311, "init", {
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true
   });
</script><title>Contributing | js-dos</title><script type="application/json" id="virtual-toc-data">[{"id":"protocol","level":0,"title":"Protocol","anchor":"#protocol"},{"id":"server","level":0,"title":"Server","anchor":"#server"},{"id":"client","level":0,"title":"Client","anchor":"#client"},{"id":"testing","level":0,"title":"Testing","anchor":"#testing"},{"id":"running-native-js-dos-v7","level":0,"title":"Running native js-dos v7","anchor":"#running-native-js-dos-v7"},{"id":"using-docker","level":0,"title":"Using Docker","anchor":"#using-docker"},{"id":"contributing-on-github","level":0,"title":"Contributing on github","anchor":"#contributing-on-github"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.10.0-b419/app.css" rel="stylesheet"><link rel="icon" type="image/png" sizes="16x16" href="images/logo-16.png"><link rel="icon" type="image/png" sizes="32x32" href="images/logo-32.png"><link rel="icon" type="image/png" sizes="96x96" href="images/logo-192.png"><link rel="icon" type="image/png" sizes="300x300" href="images/logo-512.png"><meta name="image" content="https://js-dos.com/images/seo.jpg"><!-- Open Graph --><meta property="og:title" content="Contributing | js-dos"><meta property="og:description" content=""><meta property="og:image" content="https://js-dos.com/images/seo.jpg"><meta property="og:site_name" content="js-dos Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="https://js-dos.com//8.xx/contributing-emulators.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@caiiiycuk"><meta name="twitter:title" content="Contributing | js-dos"><meta name="twitter:description" content=""><meta name="twitter:creator" content="@caiiiycuk"><meta name="twitter:image:src" content="https://js-dos.com/images/seo.jpg"><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "https://js-dos.com//8.xx/contributing-emulators.html#webpage",
    "url": "https://js-dos.com//8.xx/contributing-emulators.html",
    "name": "Contributing | js-dos",
    "description": "",
    "image": "https://js-dos.com/images/seo.jpg",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "https://js-dos.com/#website",
    "url": "https://js-dos.com/",
    "name": "js-dos Help"
}</script><!-- End Schema.org --></head><body data-id="contributing-emulators" data-main-title="Contributing" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="emulators.md|emulators"><noscript><div><img src="https://mc.yandex.ru/watch/27763311" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>js-dos 8.xx Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="contributing-emulators" id="contributing-emulators.md">Contributing</h1><p id="-nb1auy_2">To contribute to the <code class="code" id="-nb1auy_15">emulators</code> package, do the following:</p><ol class="list _decimal" id="-nb1auy_3" type="1"><li class="list__item" id="-nb1auy_16"><p>Checkout <code class="code" id="-nb1auy_17">emulators</code> repository</p></li></ol><p id="-nb1auy_4"><code class="code" id="-nb1auy_18">git clone https://github.com/js-dos/emulators</code></p><ol class="list _decimal" id="-nb1auy_5" type="1" start="2"><li class="list__item" id="-nb1auy_19"><p id="-nb1auy_22">Install <a href="https://emscripten.org/docs/tools_reference/emsdk.html" id="-nb1auy_23" data-external="true" rel="noopener noreferrer">emscripten sdk</a>, and confgure environment to use it.</p></li><li class="list__item" id="-nb1auy_20"><p id="-nb1auy_24">Install <a href="https://cmake.org/" id="-nb1auy_25" data-external="true" rel="noopener noreferrer">cmake</a> and <a href="https://gulpjs.com/" id="-nb1auy_26" data-external="true" rel="noopener noreferrer">gulp 4</a>.</p></li><li class="list__item" id="-nb1auy_21"><p id="-nb1auy_27">Now you can build everything with <code class="code" id="-nb1auy_28">gulp</code> command</p></li></ol><p id="-nb1auy_6">Native part of emulators is a plain cmake project, you can open it in your favorite editor. The Project has the following targets:</p><ol class="list _decimal" id="-nb1auy_7" type="1"><li class="list__item" id="-nb1auy_29"><p><span class="control" id="-nb1auy_35"><code class="code" id="-nb1auy_38">sokol</code></span> - js-dos v7 native version: dosbox + UI based on <a href="https://github.com/floooh/sokol" id="-nb1auy_36" data-external="true" rel="noopener noreferrer">sokol</a>. This version is exactly the same as the web version. <span class="control" id="-nb1auy_37">You should use this target to contribute to js-dos v7.</span></p></li><li class="list__item" id="-nb1auy_30"><p><span class="control" id="-nb1auy_39"><code class="code" id="-nb1auy_41">direct</code></span> - target is used to build the web-direct version of js-dos v7. You can compile it only with <span class="control" id="-nb1auy_40">emscripten</span>.</p></li><li class="list__item" id="-nb1auy_31"><p><span class="control" id="-nb1auy_42"><code class="code" id="-nb1auy_44">worker</code></span> - target is used to build the web-worker version of js-dos v7. You can compile it only with <span class="control" id="-nb1auy_43">emscripten</span>.</p></li><li class="list__item" id="-nb1auy_32"><p><code class="code" id="-nb1auy_45">dosbox</code> - original version of dosbox (UI based on SDL). You can use it to compare behaviour between original dosbox and js-dos v7.</p></li><li class="list__item" id="-nb1auy_33"><p><code class="code" id="-nb1auy_46">libzip</code> - shared codes that contain implementation of zip.</p></li><li class="list__item" id="-nb1auy_34"><p><code class="code" id="-nb1auy_47">jsdos</code> - shared codes that contain implementation of dosbox.</p></li></ol><section class="chapter"><h2 id="protocol" data-toc="protocol">Protocol</h2><p id="-nb1auy_48">The idea of new js-dos v7 is that all targets (native and web) have exactly the same way to communicate between a client (native UI, browser UI) and dosbox.</p><div class="code-block" data-lang="c">
//
// Created by caiiiycuk on 27.02.2020.
//

#ifndef JS_DOS_JS_DOS_PROTOCOL_H
#define JS_DOS_JS_DOS_PROTOCOL_H

#include &lt;keyboard.h&gt;
#include &lt;cstdint&gt;

enum NetworkType {
  NETWORK_NA = -1,
  NETWORK_DOSBOX_IPX = 0,
};

// -- Client (Web Page)

void client_frame_set_size(int width, int height);
void client_frame_update_lines(uint32_t* lines, uint32_t count, void* rgba);
void client_sound_init(int freq);
void client_sound_push(const float* samples, int num_samples);
void client_stdout(const char* data, uint32_t amount);

void client_log(const char* tag, const char* message);
void client_warn(const char* tag, const char* message);
void client_error(const char* tag, const char* message);

void client_network_connected(NetworkType networkType, const char* address, uint32_t port);
void client_network_disconnected(NetworkType networkType);

#ifndef EMSCRIPTEN
extern void client_tick();
#endif

// -- Server (Worker)

extern int server_run();
extern void server_add_key(KBD_KEYS key, bool pressed, uint64_t pressedMs);
extern void server_mouse_moved(float x, float y, bool relative, uint64_t movedMs);
extern void server_mouse_button(int button, bool pressed, uint64_t pressedMs);
extern void server_mouse_sync(uint64_t syncMs);
extern void server_pause();
extern void server_resume();
extern void server_mute();
extern void server_unmute();
extern void server_exit();

extern void server_network_connect(NetworkType networkType, const char* address, uint32_t port);
extern void server_network_disconnect(NetworkType networkType);

#endif  // JS_DOS_JS_DOS_PROTOCOL_H
</div></section><section class="chapter"><h2 id="server" data-toc="server">Server</h2><p id="-nb1auy_50">For simplicity, you can think that the server is a dosbox. In the future, servers can be implemented with different emulators. Now we support only <span class="control" id="-nb1auy_54">dosbox implementation</span> (look at <code class="code" id="-nb1auy_55">jsdos.cmake</code>).</p><section class="chapter"><h3 id="server-run" data-toc="server-run">server_run()</h3><p id="-nb1auy_56">Client should run this function when it's ready to start dosbox. This function will start the emulator. Client should prepare a file system for dosbox <span class="control" id="-nb1auy_58">it expects that <code class="code" id="-nb1auy_59">cwd</code> contains <code class="code" id="-nb1auy_60">.jsdos/dosbox.conf</code> file</span>.</p><p id="-nb1auy_57">So you need to extract <a href="jsdos-bundle.html" id="-nb1auy_61" data-tooltip="If you are looking way to run your favorite game in browser, but do not want to develop website, then please create bundle for it using this guide, and send request to publis it on dos.zone">js-dos bundle</a> in some directory and start sokol binary in this directory, and it will act exactly in the same way as direct/worker dosbox.</p></section><section class="chapter"><h3 id="server-add-key-keycode-pressed-timems" data-toc="server-add-key-keycode-pressed-timems">server_add_key(keycode, pressed, timeMs)</h3><p id="-nb1auy_62">This function adds keycode to the queue. They will be processed when dosbox poll keyboard events.</p></section><section class="chapter"><h3 id="server-exit" data-toc="server-exit">server_exit()</h3><p id="-nb1auy_63">Terminates execution of dosbox and free resources.</p></section></section><section class="chapter"><h2 id="client" data-toc="client">Client</h2><p id="-nb1auy_64">Direct, worker, and sokol implementations share the same code for server part. But they are completely different, because they implement UI and sound system for different platforms. In the original dosbox this was made by SDL, it was hard-coupled with dosbox. js-dos clearly detach the emulator from its ui. You can easily add new UI/sound system to dosbox.</p><p id="-nb1auy_65">For example, let's look at sokol UI implementation. You can use it to debug and develop new features for js-dos. Worker is a primary web implementation for js-dos v7. sokol implementation tries to work in a similar way: we start dosbox emulator in main thread and client in new thread.</p><div class="code-block" data-lang="cpp">
void runRuntime() {
  std::thread client(client_run);
  server_run();
  client.join();
}
</div><section class="chapter"><h3 id="client-frame-set-size-width-height" data-toc="client-frame-set-size-width-height">client_frame_set_size(width, height)</h3><p id="-nb1auy_73">When the server starts, it will send the frame size of the dosbox window by invoking <code class="code" id="-nb1auy_75">client_frame_set_size</code>. You should allocate rgba buffer to store frame content. This function will be called each time when dosbox window size is changed.</p><div class="code-block" data-lang="cpp">
extern int frameWidth = 0;
extern int frameHeight = 0;
extern uint32_t *frameRgba = 0;

void client_frame_set_size(int width, int height) {
  std::lock_guard&lt;std::mutex&gt; g(mutex);

  if (frameRgba) {
    delete[] frameRgba;
  }
  frameWidth = width;
  frameHeight = height;
  frameRgba = new uint32_t[width * height];
}
</div></section><section class="chapter"><h3 id="client-frame-update-lines-lines-count-rgba" data-toc="client-frame-update-lines-lines-count-rgba">client_frame_update_lines(lines, count, rgba)</h3><p id="-nb1auy_76">This method will be called each time if contents of dosbox window are changed. dosbox implementation will send only changed lines. You need to update your frame buffer correctly.</p><p id="-nb1auy_77">Dirty region format (lines argument):</p><ul class="list _bullet" id="-nb1auy_78"><li class="list__item" id="-nb1auy_82"><p>line number [0, height)</p></li><li class="list__item" id="-nb1auy_83"><p>count of changed lines</p></li><li class="list__item" id="-nb1auy_84"><p>offset in passed buffer (rgba argument)</p></li></ul><div class="code-block" data-lang="cpp">
void client_frame_update_lines(uint32_t *lines, uint32_t count, void *rgba) {
  std::lock_guard&lt;std::mutex&gt; g(mutex);

  frameCount++;
  if (!frameRgba) {
    return;
  }

  for (uint32_t i = 0; i &lt; count; ++i) {
    uint32_t start = lines[i * 3];
    uint32_t count = lines[i * 3 + 1];
    uint32_t offset = lines[i * 3 + 2];
    memcpy(&amp;frameRgba[start * frameWidth], (char *)rgba + offset,
           sizeof(uint32_t) * count * frameWidth);
  }
}
</div><p id="-nb1auy_80">Implementing <code class="code" id="-nb1auy_85">client_frame_set_size</code> and <code class="code" id="-nb1auy_86">client_frame_update_lines</code> is enough to render dosbox window:</p><div class="code-block" data-lang="cpp">
// ... 
   appDescription.frame_cb = []() { sokolFrame(); };
// ...

void sokolFrame() {
  std::lock_guard&lt;std::mutex&gt; g(mutex);

  // ...
  
  sg_image_content imageContent = {};
  imageContent.subimage[0][0] = {};
  imageContent.subimage[0][0].ptr = frameRgba;
  imageContent.subimage[0][0].size =
      (state-&gt;width) * (state-&gt;height) * (int)sizeof(uint32_t);

  sg_update_image(state-&gt;bind.fs_images[0], &amp;imageContent);

  sg_begin_default_pass(&amp;state-&gt;pass, state-&gt;width, state-&gt;height);
  sg_apply_pipeline(state-&gt;pipeline);
  sg_apply_bindings(&amp;state-&gt;bind);
  sg_draw(0, 4, 1);
  sg_end_pass();
  sg_commit();

  renderedFrame = frameCount;
}
</div></section><section class="chapter"><h3 id="client-sound-init-freq" data-toc="client-sound-init-freq">client_sound_init(freq);</h3><p id="-nb1auy_87">Called when the dosbox needs to initialize the sound system.</p><div class="code-block" data-lang="cpp">
void client_sound_init(int freq) {
  saudio_desc audioDescription = {};
  audioDescription.sample_rate = static_cast&lt;int&gt;(freq);
  audioDescription.num_channels = 1;

  saudio_setup(&amp;audioDescription);
  assert(saudio_isvalid());
}
</div></section><section class="chapter"><h3 id="client-sound-push-samples-num-samples" data-toc="client-sound-push-samples-num-samples">client_sound_push(samples, num_samples)</h3><p id="-nb1auy_89">This method is called each time when new sound samples should be pushed to audio device. With sokol implementation is very simple:</p><div class="code-block" data-lang="cpp">
void client_sound_push(const float *samples, int num_samples) {
  saudio_push(samples, num_samples);
}
</div></section><section class="chapter"><h3 id="client-stdout-data-amount" data-toc="client-stdout-data-amount">client_stdout(data, amount)</h3><p id="-nb1auy_91">This method will be called each time when dosbox prints something to its console.</p></section><section class="chapter"><h3 id="communicate-to-server" data-toc="communicate-to-server">Communicate to server</h3><p id="-nb1auy_92">Each time when key is pressed we should send event to dosbox:</p><div class="code-block" data-lang="cpp">
// ...
  appDescription.event_cb = [](const sapp_event *event) {
    switch (event-&gt;type) {
      case SAPP_EVENTTYPE_KEY_DOWN:
      case SAPP_EVENTTYPE_KEY_UP:
        keyEvent(event);
        break;
      default:;
    }
  };
// ...


void keyEvent(const sapp_event *event) {
  server_add_key(
      (KBD_KEYS)event-&gt;key_code,
      event-&gt;type == SAPP_EVENTTYPE_KEY_DOWN,
      GetMsPassedFromStart());
}
</div><p id="-nb1auy_94">When user closes sokol window we need to stop server:</p><div class="code-block" data-lang="cpp">
  appDescription.cleanup_cb = []() { server_exit(); };
</div><p id="-nb1auy_96">That is. Check complete <a href="https://github.com/js-dos/emulators/tree/main/src/dos/sokol" id="-nb1auy_97" data-external="true" rel="noopener noreferrer">source</a> of sokol implementation.</p></section></section><section class="chapter"><h2 id="testing" data-toc="testing">Testing</h2><p id="-nb1auy_98">If the <code class="code" id="-nb1auy_103">gulp</code> command is finished successfully then you can run emulators tests. To do this, run a static web server to host the <code class="code" id="-nb1auy_104">dist</code> directory. For example, with <code class="code" id="-nb1auy_105">http-server</code>:</p><div class="code-block" data-lang="none">
http-server dist
</div><p id="-nb1auy_100">and open test page in browser:</p><div class="code-block" data-lang="none">
firefox http://127.0.0.1:8080/test/test.html
</div><p id="-nb1auy_102">all tests should pass.</p></section><section class="chapter"><h2 id="running-native-js-dos-v7" data-toc="running-native-js-dos-v7">Running native js-dos v7</h2><p id="-nb1auy_106">As said above, you need to compile a <code class="code" id="-nb1auy_108">sokol</code> target with your favorite C++ toolkit. It will generate <code class="code" id="-nb1auy_109">sokol</code> executable. Next, you need to download some <a href="jsdos-bundle.html" id="-nb1auy_110" data-tooltip="If you are looking way to run your favorite game in browser, but do not want to develop website, then please create bundle for it using this guide, and send request to publis it on dos.zone">js-dos bundle</a> for example <a href="https://cdn.dos.zone/original/2X/2/24b00b14f118580763440ecaddcc948f8cb94f14.jsdos" id="-nb1auy_111" data-external="true" rel="noopener noreferrer">digger</a>.</p><p id="-nb1auy_107"><code class="code" id="-nb1auy_112">js-dos bundle</code> is a plain zip archive, you need to extract it in some folder. After that you should run <code class="code" id="-nb1auy_113">sokol</code> executable from that folder (cwd must be the root of the extracted bundle).</p></section><section class="chapter"><h2 id="using-docker" data-toc="using-docker">Using Docker</h2><p id="-nb1auy_114">You can use docker image to develop emulators core. The image has already configured everything to build emulators core and start emulators tests.</p><section class="chapter"><h3 id="build-image" data-toc="build-image">Build image</h3><div class="code-block" data-lang="none">
    docker build -t emulators . 
</div></section><section class="chapter"><h3 id="test-image" data-toc="test-image">Test image</h3><div class="code-block" data-lang="none">
    docker run -p 8080:8080 -ti emulators
</div><p id="-nb1auy_120">Open <code class="code" id="-nb1auy_121">http://localhost:8080</code> in browser, all tests should pass</p></section><section class="chapter"><h3 id="development" data-toc="development">Development</h3><p id="-nb1auy_122">Run inside the project directory:</p><div class="code-block" data-lang="none">
    docker run -v `pwd`/src:/app/src -v `pwd`/test:/app/test -v `pwd`/dist:/app/dist -ti emulators bash
    source /emsdk/emsdk_env.sh
    gulp OR ./node_modules/.bin/tsc --watch
</div><p id="-nb1auy_124">Use your code editor to edit the content of src and test. In the docker VM you can run <code class="code" id="-nb1auy_125">gulp</code> to build everything into <code class="code" id="-nb1auy_126">dist</code> OR use <code class="code" id="-nb1auy_127">./node_modules/.bin/tsc --watch</code> if you need only compile time checks.</p></section></section><section class="chapter"><h2 id="contributing-on-github" data-toc="contributing-on-github">Contributing on github</h2><p id="-nb1auy_128">To contribute your code please create PR on github, and check if all tests passed.</p></section><div class="last-modified">Last modified: 03 октября 2024</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="estimating-performance.html" class="navigation-links__prev">Performance testing</a><a href="doszone.html" class="navigation-links__next">dos.zone</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.10.0-b419/app.js"></script></body></html>